<!DOCTYPE html>
<html>
  <head>
    <title>AI 쇼츠 비디오 생성</title>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <!-- Bootstrap Material Design -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-material-design@4.1.2/dist/css/bootstrap-material-design.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap-material-design@4.1.2/dist/js/bootstrap-material-design.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script>
      $(document).ready(function () {
        let videoCount = 0;
        let videosInfo = {}; // 비디오 정보를 저장할 객체

        function updateVideosInfo() {
          const jsonString = JSON.stringify(videosInfo);
          console.log(jsonString); // 콘솔에 JSON 문자열 출력
          $('#id_videos_info').val(jsonString);
        }

        $('#addVideo').click(function (e) {
          console.log('Clicked addVideo');
          e.preventDefault();
          videoCount++;
          const videoId = `video_${videoCount}`;
          videosInfo[videoId] = {
            url: '', // URL 필드 추가
            title: '',
            subtitle: '',
          };

          const videoFields = `
                <div class="video-group mb-3" id="video-group-${videoCount}">
                    <div class="form-group">
                        <label for="video_url_${videoCount}">비디오 URL:</label>
                        <input type="text" class="form-control video-url" data-video-id="${videoId}" placeholder="비디오 URL을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="video_title_${videoCount}">제목:</label>
                        <input type="text" class="form-control video-title" data-video-id="${videoId}" placeholder="비디오 제목을 입력하세요" required>
                    </div>
                    <div class="form-group">
                        <label for="video_subtitle_${videoCount}">부제목:</label>
                        <input type="text" class="form-control video-subtitle" data-video-id="${videoId}" placeholder="비디오 부제목을 입력하세요" required>
                    </div>
                    <button type="button" class="btn btn-danger remove-video" data-target="#video-group-${videoCount}" data-video-id="${videoId}">제거</button>
                </div>
                `;
          $('#videosContainer').append(videoFields);

          // 비디오 정보 업데이트 함수 호출
          updateVideosInfo();
        });

        $(document).on(
          'change',
          '.video-url, .video-title, .video-subtitle',
          function () {
            const videoId = $(this).data('video-id');
            const fieldClass = $(this).attr('class').split(' ')[1];
            const fieldValue = $(this).val();

            // 입력된 값이 있는지 확인
            if (fieldValue.trim() !== '') {
              if (!videosInfo[videoId]) {
                videosInfo[videoId] = {};
              }
              if (fieldClass.includes('url')) {
                videosInfo[videoId].url = fieldValue;
              } else if (fieldClass.includes('title')) {
                videosInfo[videoId].title = fieldValue; // 제목 업데이트
              } else if (fieldClass.includes('subtitle')) {
                videosInfo[videoId].subtitle = fieldValue; // 부제목 업데이트
              }

              updateVideosInfo();
            }
          }
        );
      });
    </script>
  </head>
  <body>
    <div class="container mt-5">
      <h1 class="text-center mb-4">비디오 생성</h1>
      <form method="post" class="mt-3" enctype="multipart/form-data">
        {% csrf_token %}
        <div class="form-group">
          <label for="title">{{ form.title.label }}</label>
          {{ form.title }}
        </div>
        <label for="voice_select">목소리 선택:</label>
        <select class="form-control" id="voice_select" name="voice_id">
          {% for voice in cloned_voices %}
          <option value="{{ voice.voice_id }}">{{ voice.name }}</option>
          {% endfor %}
        </select>

        <input type="hidden" id="id_videos_info" name="videos_info" value="" />
        <div id="videosContainer">
          <!-- 동적으로 추가될 비디오 필드가 위치할 컨테이너 -->
        </div>
        <button type="button" id="addVideo" class="btn btn-info mb-3">
          비디오 추가
        </button>

        <div class="form-group">
          <label for="intro_text">{{ form.intro_text.label }}</label>
          {{ form.intro_text }}
        </div>
        <div class="form-group">
          <label for="outro_text">{{ form.outro_text.label }}</label>
          {{ form.outro_text }}
        </div>
        <div class="form-group">
          <label for="background_mp3">{{ form.background_mp3.label }}</label>
          {{ form.background_mp3 }}
        </div>
        <div class="form-group">
          <label for="intro_video_file"
            >{{ form.intro_video_file.label }}</label
          >
          {{ form.intro_video_file }}
        </div>
        <div class="form-group">
          <label for="outro_video_file"
            >{{ form.outro_video_file.label }}</label
          >
          {{ form.outro_video_file }}
        </div>
        <button type="submit" class="btn btn-primary">생성</button>
      </form>
    </div>
    {% if form.errors %}
    <script>
      document.addEventListener('DOMContentLoaded', function() {
          var formErrors = {{ form.errors.as_json|safe }};
          // formErrors는 JSON 문자열이므로, 객체로 파싱합니다.
          try {
            var errors = JSON.parse(formErrors);

            // 에러 메시지 문자열을 생성합니다.
            var errorMessage = "";
            for (var field in errors) {
                if (errors.hasOwnProperty(field)) {
                    errorMessage += field + ": " + errors[field] + "\n";
                }
            }
        } catch (e) {
            console.error("JSON 파싱 오류:", e);
        }

          // 에러 메시지가 있으면 alert로 표시합니다.
          if (errorMessage) {
              alert("폼 제출에 문제가 있습니다:\n" + errorMessage);
          }
      });
    </script>
    {% endif %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        if (success) {
          alert('성공적으로 생성되었습니다.');
          window.history.replaceState(null, null, window.location.pathname); // URL에서 파라미터 제거
        }
      });
    </script>
  </body>
</html>
